{% extends 'main.html' %} {% block content %}
<div class="container">
  <div
    class="card alert {{ 'alert-danger' if pred == 1 else 'alert-success' }}"
  >
    <center>
      {{ "At risk of " + disease_name + "." if pred == 1 else "Looks like you
      don't have " + disease_name + "!" }}
    </center>
  </div>

  <div class="prediction">
    <div class="left">
      <table class="table">
        <thead>
          <tr>
            <th style="font-size: 1.5em">Your Submitted Values:</th>
          </tr>
          <!-- <tr>
                            <th>Key</th>
                            <th>Value</th>
                        </tr> -->
        </thead>
        <tbody>
          {% for key, value in submitted_values.items() %}
          <tr>
            <td>{{ key }}</td>
            <td>{{ value }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      <h1>Ask me anything.</h1>
      <div id="chatBox" class="chat-box">
        <!-- Messages will appear here -->
      </div>
      <div class="bottom-chat">
        <input
          type="text"
          id="userMessage"
          class="input-message"
          placeholder="Type your message..."
        />
        <button class="button-send" onclick="sendMessage()">Send</button>
        <button class="button-find" onclick="findDoctor()">Doctors</button>
      </div>
    </div>

    <div class="LLM">{{text | safe}}</div>
  </div>
</div>

<script>
  async function sendMessage() {
    const messageInput = document.getElementById("userMessage");
    const chatBox = document.getElementById("chatBox");
    const llmText = document.querySelector(".LLM").innerText; // Access the LLM text content
    const userMessage = messageInput.value.trim();
    const guidelines =
      "You are a medical advisor bot. Your responses must NOT have have markdown. Your responses must be in plain text with only <Br> and <Strong>. Remember, NOT markdown.  Keep your answers simple, concise and to the point. You can only answer within your context and with only the information provided below. If the user's query goes outside the scope, you must respond with a gentle warning. Below is the context based on which you can answer. The context is a report generated by an LLM for the user. Your answers must be within this context and YOU MUST give medical advise as long as the query is seeking medical advice RELATED to the context. You MUST NOT say that you cannot provide medical advice. YOU ARE A MEDICAL ADVISOR. PROVIDING ADVICE IS YOUR JOB. Remember NO MARKDOWN. YOU MUST NOT PROVIDE ANY DISCLAIMER. NO DISCLAIMERS.";

    if (!userMessage) return;

    // Combine userMessage with llmText
    const combinedMessage = `${guidelines}\n\n${llmText}\n\nUser Query:\n\n${userMessage}`;

    // Display user's message
    chatBox.innerHTML += `<div><strong>You:</strong> ${userMessage}</div>`;
    messageInput.value = "";

    // Fetch response from the server
    try {
      const response = await fetch("/chat", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ message: combinedMessage }), // Send combined message
      });

      // Ensure the response is valid
      if (!response.ok) {
        const errorText = await response.text(); // Get the raw response text
        chatBox.innerHTML += `<div><strong>Error:</strong> ${errorText}</div>`;
        return;
      }

      const data = await response.json(); // Attempt to parse as JSON

      if (data.error) {
        chatBox.innerHTML += `<div><strong>Error:</strong> ${data.error}</div>`;
      } else {
        chatBox.innerHTML += `<div><strong>Bot:</strong> ${data.response}</div>`;
      }
      chatBox.scrollTop = chatBox.scrollHeight; // Scroll to the latest message
    } catch (error) {
      chatBox.innerHTML += `<div><strong>Error:</strong> ${error.message}</div>`;
    }
  }
</script>

<script>
  function findDoctor() {
    const diseaseName = encodeURIComponent("{{ disease_name }}"); // Encode in JavaScript
    const query = `${diseaseName} doctors near me`;
    const googleMapsUrl = `https://www.google.com/maps/search/${query}`;

    // Open Google Maps search in a new tab
    window.open(googleMapsUrl, "_blank");
  }
</script>
{% endblock %}
